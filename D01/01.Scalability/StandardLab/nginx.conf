worker_processes 1; # Số lượng worker process (thường = số CPU cores)

events { 
    # Số kết nối đồng thời (concurrent) mà mỗi worker có thể xử lý CÙNG LÚC
    # Không phải theo thời gian, mà là số kết nối đang hoạt động tại bất kỳ thời điểm nào
    # Tổng capacity = worker_processes × worker_connections = 1 × 1024 = 1024 concurrent connections
    # Khi 1 kết nối đóng → giải phóng slot → kết nối mới có thể vào ngay
    worker_connections 1024; 
}

http {
    # Định nghĩa Upstream: Danh sách các App Clones
    upstream app_backend {
        # Least Connections: Chọn server có ít kết nối đang hoạt động nhất
        # Khác với Round Robin khi có requests chậm hoặc long-lived connections
        least_conn;

        # App clones (phải khớp tên service trong docker-compose.yml)
        # max_fails=3: Chỉ cần 3 lần fail là đánh dấu server down
        # fail_timeout=5s: Sau 5s sẽ thử lại server (thời gian "cấm" và chu kỳ thử lại)
        server app_clone_1:5000 max_fails=3 fail_timeout=5s;
        server app_clone_2:5000 max_fails=3 fail_timeout=5s;
    }

    server {
        listen 80;
        location / {
            # Proxy request tới nhóm server backend
            # Tên "app_backend" phải khớp chính xác với tên trong "upstream app_backend"
            proxy_pass http://app_backend;

            # === TIMEOUT SETTINGS - Flow của 1 HTTP request ===
            # Flow: Client → Nginx → [1.Connect] → [2.Send] → Backend xử lý → [3.Read] → Nginx → Client
            
            # [1] proxy_connect_timeout: Thời gian chờ thiết lập kết nối TCP với backend
            # - Giai đoạn: TCP 3-way handshake
            #   + Nginx gửi SYN (synchronize) → "Tôi muốn kết nối"
            #   + Backend gửi SYN-ACK (synchronize-acknowledge) → "OK, tôi đồng ý"
            #   + Nginx gửi ACK (acknowledge) → "Xác nhận, kết nối thành công"
            # - Nếu server down → Không nhận được SYN-ACK → Timeout sau 2s → Thử server khác
            # - Trade-off:
            #   + Timeout ngắn (2s): Phát hiện fail nhanh, user không chờ lâu
            #   + Timeout ngắn: Network chậm có thể bị false positive (server sống nhưng bị đánh dấu down)
            #   + Timeout dài (60s): Chịu được network chậm, ít false positive
            #   + Timeout dài: User phải chờ lâu khi server thật sự down
            # - Khuyến nghị: Internal network/Docker (2-5s), Internet/WAN (10-30s)
            proxy_connect_timeout 2s;
            
            # [2] proxy_send_timeout: Thời gian chờ gửi HTTP request đến backend
            # - Giai đoạn: Sau khi TCP connect thành công, gửi HTTP request qua connection đó
            # - Timeout nếu backend không nhận hết request trong 2s (network quá chậm hoặc backend quá tải)
            # proxy_send_timeout 2s;
            
            # [3] proxy_read_timeout: Thời gian chờ nhận HTTP response từ backend
            # - Giai đoạn: Backend xử lý xong, gửi response về nginx
            # - Timeout nếu backend không trả response trong 10s
            # - Tăng lên 10s để xử lý các request chậm (ví dụ: /slow endpoint, database query phức tạp)
            # proxy_read_timeout 10s;

            # Giữ nguyên hostname mà client gửi đến (ví dụ: example.com)
            # Quan trọng khi backend cần biết domain gốc để xử lý virtual hosts, redirects
            proxy_set_header Host $host;

            # Truyền IP thực của client đến backend
            # Không có header này → backend chỉ thấy IP của nginx, không biết IP client thật
            # Dùng cho logging, security, geolocation, rate limiting
            proxy_set_header X-Real-IP $remote_addr;

            # Lưu chuỗi tất cả IP mà request đi qua (client → proxy1 → proxy2 → backend)
            # Ví dụ: X-Forwarded-For: 192.168.1.100, 10.0.0.1, 10.0.0.2
            # Hữu ích khi có nhiều tầng proxy/load balancer
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Truyền protocol gốc (http hoặc https) mà client sử dụng
            # Backend cần biết để tạo redirect URLs đúng
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}