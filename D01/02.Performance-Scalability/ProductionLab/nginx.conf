worker_processes 1;
events { worker_connections 1024; }
http {

    # Timeouts for upstream connections (Stability Pattern: Timeouts)
    proxy_connect_timeout 2s;  # Tối đa 2 giây để thiết lập kết nối
    proxy_read_timeout 10s;    # Tối đa 10 giây để đọc phản hồi
    proxy_send_timeout 10s;

    # Case A: Baseline Scalability Test 
    upstream baseline_servers {
        server app1:8000;
        server app2:8000;
    }
    
    # Case B: Optimized Scalability Test (Weighted Load Balancing)
    # Tăng trọng số cho App1 (3 worker) vs App2 (1 worker)
    upstream optimized_servers {
        server app1:8000 weight=3 max_fails=3 fail_timeout=5s; 
        server app2:8000 weight=1 max_fails=3 fail_timeout=5s; 
    }
    
    # Case C: Stability/Failover Test (Simulating Down Node)
    upstream failover_servers {
        # max_fails=3, fail_timeout=5s: Nếu 3 request liên tiếp fail trong 5s,
        # Nginx sẽ coi node đó là DOWN trong 5s (Cơ chế Circuit Breaker cơ bản).
        server app1:8000 max_fails=1 fail_timeout=1s;
        server app2:8000 down; 
    }

    server {
        listen 80;

        location /test/baseline {
            proxy_pass http://baseline_servers;
        }

        location /test/optimized {
            proxy_pass http://optimized_servers;
        }

        location /test/failover {
            proxy_pass http://failover_servers;
        }

        location /health {
            proxy_pass http://app1:8000;
        }
    }
}