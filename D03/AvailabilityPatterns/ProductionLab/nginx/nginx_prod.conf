# nginx/nginx_prod.conf (Active-Active Hardened)
upstream backend {
    # Tinh chỉnh fail_timeout xuống 1 giây (nhanh hơn 5s trước)
    # Circuit Breaker sẽ kích hoạt cực nhanh.
    server app-server-a:8000 max_fails=3 fail_timeout=1s; 
    server app-server-b:8000 max_fails=3 fail_timeout=1s;
}

server {
    listen 80;
    
    # Root endpoint cho client traffic
    location / {
        proxy_pass http://backend;
        # Tự động chuyển request sang server khác nếu gặp lỗi timeout, 50x
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504; 
    }
    
    # Endpoint Deep Health Check (Nếu Nginx Plus được dùng cho Active Check)
    # Hiện tại chúng ta dựa vào Passive Health Check của proxy_pass
    location /health_check {
        proxy_pass http://backend/deep_health;
    }
}